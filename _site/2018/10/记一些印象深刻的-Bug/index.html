<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>记一些印象深刻的 Bug</title>
  <meta name="description" content="目录">
  <meta name="author" content="leopardpan">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="记一些印象深刻的 Bug">
  <meta name="twitter:description" content="目录">
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="记一些印象深刻的 Bug">
  <meta property="og:description" content="目录">
  
  <link rel="icon" type="image/png" href="/images/favicon.png" />
  <link href="/images/favicon.png" rel="shortcut icon" type="image/png">
  
  <link rel="stylesheet" href="/css/main.css">
  <link href="//libs.baidu.com/fontawesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/2018/10/%E8%AE%B0%E4%B8%80%E4%BA%9B%E5%8D%B0%E8%B1%A1%E6%B7%B1%E5%88%BB%E7%9A%84-Bug/">
  <link rel="alternate" type="application/rss+xml" title="cocoafei" href="http://localhost:4000/feed.xml">

<!-- 百度统计 -->
  

<!-- google 统计 -->
  

</head>


  <body>

    <span class="mobile btn-mobile-menu">        
      <div class="nav_container">
         <nav class="nav-menu-item" style = "float:right">
            <i class="nav-menu-item">
              <a href="/#blog" title="" class="blog-button">  博客主页
              </a>
            </i>
            
                <i class="nav-menu-item">

                  <a href="/archive" title="archive" class="btn-mobile-menu__icon">
                      所有文章
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/tags" title="tags" class="btn-mobile-menu__icon">
                      标签
                  </a>
                </i>
            
                <i class="nav-menu-item">

                  <a href="/about" title="about" class="btn-mobile-menu__icon">
                      关于我
                  </a>
                </i>
            
          </nav>
      </div>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/images/background-cover.png')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <!-- 头像效果-start -->
        <div class="ih-item circle effect right_to_left">            
            <a href="/#blog" title="前往 cocoafei 的主页" class="blog-button">
                <div class="img"><img src="/images/avatar.jpg" alt="img"></div>
                <div class="info">
                    <div class="info-back">
                        <h2> 
                            
                                cocoafei
                            
                        </h2>
                        <p>
                           
                                iOS / Python
                            
                        </p>
                    </div>
                </div>
            </a>
        </div>
        <!-- 头像效果-end -->
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for cocoafei" class="blog-button">cocoafei</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">个人站</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">欢迎来到我的Blog~</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        
        
        

        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">博客主页</a></li>
                
                  <li class="navigation__item"><a href="/archive" title="archive">所有文章</a></li>
                
                  <li class="navigation__item"><a href="/tags" title="tags">标签</a></li>
                
                  <li class="navigation__item"><a href="/about" title="about">关于我</a></li>
                
              </ul>
            </nav>
          </div>          
        </div>


        </div>
      </div>
    </div>
    
    
    <div class="panel-cover--overlay cover-clear"></div>
    
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title">记一些印象深刻的 Bug</h1>
    <div class="post-meta">
      <img src="/images/calendar.png" width="20px" style="vertical-align:middle;"/> 
      <time datetime="2018-10-25 00:00:00 +0800" itemprop="datePublished" class="post-meta__date date" style="vertical-align:middle;">2018-10-25</time>
    </p>  
    </div>
  </header>

  <section class="post">
    <h2 id="目录">目录</h2>

<p>一、<a href="#1_0">iOS 加载超大尺寸图片 Crash 的调研及解决方案</a></p>

<p>二、<a href="#2_0">夏令时引起某些时间段转换为 NSDate 为 nil 问题的解决方案</a></p>

<p>三、<a href="#3_0">日期格式 YYYY-MM-dd 和 yyyy-MM-dd 区别</a></p>

<p>四、<a href="#4_0">iOS 局部 BOOL 变量随机值</a></p>

<p>五、<a href="#5_0">iPhone 用户名包含特殊符号引起的后台 Crash</a></p>

<p>六、<a href="#6_0">参考链接</a></p>

<hr />

<h2 id="-一ios-加载超大尺寸图片-crash-的调研及解决方案"><a id="1_0"></a> 一、iOS 加载超大尺寸图片 Crash 的调研及解决方案</h2>

<h3 id="-11问题描述"><a id="1_1"></a> 1.1、问题描述</h3>

<p>前段时间遇到一个工单，客户反馈，只要进入订单列表界面 1~2 秒，客户端就会 Crash，订单列表界面示意如下：</p>

<p><img src="/images/posts/bugs/impressive1.1.0.png" title="订单示意图" width="300" /></p>

<h3 id="-12问题分析"><a id="1_2"></a> 1.2、问题分析</h3>

<p>由于是客户投诉的 Bug，没有 Debug 信息，先猜测各种情况，数组越界/后台传 nil 值/内存泄露/ KVO 赋未定义值等等；然而经过仔细分析模拟逐个排除了上述可能，仍查找不到 Crash 原因，百思不得其解。</p>

<p>排除了代码的问题，只有可能是数据问题了，猜测是异常的图片/数据解析出现的问题，于是抽取用户订单数据分析，发现有 2 张尺寸非常大的 JPEG 图片，尺寸达到了 15000*8000 的像素，瞬间想明白了怎么回事，像素总量达到了一亿两千万，猜测是图片解压缩到内存后占用内存过大，导致系统内存紧张，因此系统杀死了 App 进程。</p>

<h3 id="-13问题验证"><a id="1_3"></a> 1.3、问题验证</h3>

<p>验证是否因大尺寸图片引起的错误。验证过程如下：</p>

<p>写一个类似上面订单列表的 Demo，点击 Cell 逐个加载大图图片，测试用的手机为 iPhone 7P，图片尺寸为（15000px*15000px），点击加载第二张图片就发生了 Crash，一般情况下，APP 占用系统内存 60% 左右就会被杀死进程。iPhone 7P 加载大图后的内存截图如下：</p>

<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/posts/bugs/impressive1.3.1.png" title="Demo初始占用的内存" width="160" /></div>
<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/posts/bugs/impressive1.3.2.png" title="加载一张7000×7000大图内存" width="160" /></div>
<div style="float:left;border:solid 1px 000;margin:2px;"><img src="/images/posts/bugs/impressive1.3.3.png" title="加载两张7000×7000大图内存" width="160" /></div>
<div style="clear:both;"></div>

<p><strong>Tips:</strong> 不同手机由于内存和屏幕不一样，内存超限 App 发生 Crash 的条件不一样，其中 <strong>iPhone 6P</strong> 是最容易 Crash 的，因为它有 5.5 寸的屏幕，却只有 <strong>1G 内存</strong>，加载 Assets.xcassets 图片时会加载 3x 图片，同一张网络图片，UIImageView 布局一般会按照比例放大，大屏手机图片会放大，解码后占用内存也就更大。</p>

<h3 id="-14解决方案"><a id="1_4"></a> 1.4、解决方案</h3>

<ul>
  <li><strong>约定大于配置，上传图片也要遵守一定的约定。</strong> 基于 SDWebImage/YYImage 等第三方库加载超大图引起的崩溃，可通过修改源码解决，但不建议这样做；修改源码可能会引起其他 Bug，而且大图毕竟是少数，没必要对所有图片都进行判断，个别大图单独处理即可。按照一定约定，通过管理平台限定上传图片尺寸大小，增加 APP 流畅度的同时，还能减少用户流量损失，此为最佳方案。</li>
  <li><strong>缩放图片尺寸。</strong> 如果是展示整张图片，不需要展示图片细节，受限于屏幕分辨率，太大尺寸的图片是没有意义的；如果需要做类似于图片浏览器，可对图片进行放大缩小操作的需求，大图预览的时候可加载缩略图，展示的时候切片处理。</li>
</ul>

<h3 id="-15ios-图片解码"><a id="1_5"></a> 1.5、iOS 图片解码</h3>

<p>我们常见的图片格式例如 <strong>PNG/JPG/GIF</strong> 等格式都属于<strong>图像压缩格式</strong>，解压为位图后占用的内存会非常大。</p>

<p>假设 iOS 系统从磁盘加载一张图片，首先将文件数据从磁盘读到内存中，此时在内存中仍旧是压缩格式，只有在需要的时机，才会把图片解码为无压缩的位图格式，最后 <strong>Core Animation</strong> 使用未压缩的位图数据渲染 <strong>UIImageView</strong> 的图层。</p>

<p>将压缩的图片数据解码成未压缩的位图形式，这是一个耗时的 CPU 操作，<strong>SDWebimage/YYImage</strong> 等第三方框架一般都会提前异步强制解码图片，保证了 UI 界面的流畅性。</p>

<h3 id="-16图片解码占用内存计算"><a id="1_6"></a> 1.6、图片解码占用内存计算</h3>

<p><strong>图片解码</strong>后会占用多少内存呢？其实这个很好计算，苹果手机采用 24 位真彩色显示图像，也就是 24bit(3 字节，RGB 红绿蓝三原色分别占用 8bit，每个颜色有 256 种状态)，如果是不包含 Alpha 通道(透明度)的 RGB 图片，那每个像素占用的就是 3 字节，15000px*15000px*3Byte = 644MB，如果是包含透明度的 RGBA 图片，则为 15000px*15000px*4Byte = 858MB，如图2所示，加载一张长和宽 15000px 的图片，内存暴增 858MB。</p>

<h3 id="-17图片缩放最优选择"><a id="1_7"></a> 1.7、图片缩放最优选择</h3>

<p>最常用的图片缩放方法是使用 <strong>CGContext</strong> 的 <strong>UIGraphicsGetImageFromCurrentImageContext</strong> 方法对图片进行裁剪缩放，能够满足大部分需求。但如果是处理多张大图，这时候就需要优化缩放速度了，可通过 Image I/O 框架对图片进行缩放，在工程中添加 <strong>Image I/O Framework</strong>，然后在需要使用的地方 <strong>#import &lt;ImageIO/ImageIO.h&gt;</strong> 即可，示例代码如下：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//maxPixelSize MUST BE a valid value.</span>
<span class="k">+</span> <span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nf">thumbImageFromLargeFile</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">filePath</span> <span class="nf">withConfirmedMaxPixelSize</span><span class="p">:(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">maxPixelSize</span>
<span class="p">{</span>
<span class="c1">// Create the image source (from path)</span>
<span class="n">CGImageSourceRef</span> <span class="n">src</span> <span class="o">=</span> <span class="n">CGImageSourceCreateWithURL</span><span class="p">((</span><span class="n">__bridge</span> <span class="n">CFURLRef</span><span class="p">)</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">filePath</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="c1">// Create thumbnail options</span>
<span class="n">CFDictionaryRef</span> <span class="n">options</span> <span class="o">=</span> <span class="p">(</span><span class="n">__bridge</span> <span class="n">CFDictionaryRef</span><span class="p">)</span> <span class="p">@{</span>
<span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">kCGImageSourceCreateThumbnailWithTransform</span> <span class="o">:</span> <span class="nb">@YES</span><span class="p">,</span>
<span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">kCGImageSourceCreateThumbnailFromImageAlways</span> <span class="o">:</span> <span class="nb">@YES</span><span class="p">,</span>
<span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="n">kCGImageSourceThumbnailMaxPixelSize</span> <span class="o">:</span> <span class="err">@</span><span class="p">(</span><span class="n">maxPixelSize</span><span class="p">)</span>
<span class="p">};</span>
<span class="c1">// Generate the thumbnail</span>
<span class="n">CGImageRef</span> <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">CGImageSourceCreateThumbnailAtIndex</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

<span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImage</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithCGImage</span><span class="p">:</span><span class="n">thumbnail</span><span class="p">];</span>
<span class="n">CFRelease</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">);</span>
<span class="k">return</span> <span class="n">image</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="-二夏令时引起某些时间段转换为-nsdate-为-nil-问题的解决方案"><a id="2_0"></a> 二、夏令时引起某些时间段转换为 NSDate 为 nil 问题的解决方案</h2>

<h3 id="-21问题描述"><a id="2_1"></a> 2.1、问题描述</h3>

<p>开发中我们经常会处理用户的生日，例如下面的代码，将用户生日转换为NSDate，例如下面的代码：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSString</span> <span class="o">*</span><span class="n">birthStr</span> <span class="o">=</span> <span class="s">@"1986-05-04"</span><span class="p">;</span>
<span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">formatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">formatter</span> <span class="nf">setDateFormat</span><span class="p">:</span><span class="s">@"yyyy-MM-dd"</span><span class="p">];</span>
<span class="n">NSDate</span> <span class="o">*</span> <span class="n">birDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatter</span> <span class="nf">dateFromString</span><span class="p">:</span><span class="n">birthStr</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"timeStr to date is %@ %@"</span><span class="p">,</span> <span class="n">birthStr</span><span class="p">,</span> <span class="n">birDate</span><span class="p">);</span>
</code></pre></div></div>

<p>这时候我们会惊奇的发现，birDate 为 nil ？嗯，nil。</p>

<h3 id="-22问题分析"><a id="2_2"></a> 2.2、问题分析</h3>

<p>通过Google搜索及测试，最终定位在了夏令时问题上。</p>

<blockquote>
  <p>我国解放前几年在部分地区也曾实行过夏令时。1986年4月，中央有关部门发出“在全国范围内实行夏时制的通知”，具体作法是：每年从四月中旬第一个星期日的凌晨2时整（北京时间），将时钟拨快一小时，即将表针由2时拨至3时，夏令时开始；到九月中旬第一个星期日的凌晨2时整（北京夏令时），再将时钟拨回一小时，即将表针由2时拨至1时，夏令时结束。从1986年到1991年的六个年度，除1986年因是实行夏时制的第一年，从5月4日开始到9月14日结束外，其它年份均按规定的时段施行。1992年起，夏令时暂停实行。</p>
</blockquote>

<p>看完这段描述应该就明白原因了，在中国东八时区时区，某些时间段是不存在的，例如”1988-04-10 00-00-00”至”1988-04-10 01-00-00”中间的时间段。</p>

<h3 id="-23解决方案"><a id="2_3"></a> 2.3、解决方案</h3>

<p>既然是时区引起的问题，那就把时区转换为 UTC 或 GMT 的时区即可。</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSString</span> <span class="o">*</span><span class="n">birthStr</span> <span class="o">=</span> <span class="s">@"1988-04-10 00-00-00"</span><span class="p">;</span>
<span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">formatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">formatter</span> <span class="nf">setTimeZone</span><span class="p">:[</span><span class="n">NSTimeZone</span> <span class="nf">timeZoneWithName</span><span class="p">:</span><span class="s">@"GMT"</span><span class="p">]];</span><span class="c1">// 零时区</span>
<span class="p">[</span><span class="n">formatter</span> <span class="nf">setDateFormat</span><span class="p">:</span><span class="s">@"yyyy-MM-dd HH-mm-ss"</span><span class="p">];</span>
<span class="n">NSDate</span> <span class="o">*</span> <span class="n">birDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatter</span> <span class="nf">dateFromString</span><span class="p">:</span><span class="n">birthStr</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"BirthStr convert to NSDate is %@"</span><span class="p">,</span> <span class="n">birDate</span><span class="p">);</span>
</code></pre></div></div>

<p><strong>Tips:</strong> <strong>不要用模拟器测试</strong>，模拟器测试<strong>结果不正确</strong>。</p>

<h2 id="-三日期格式-yyyy-mm-dd-和-yyyy-mm-dd-区别"><a id="3_0"></a> 三、日期格式 YYYY-MM-dd 和 yyyy-MM-dd 区别</h2>

<h3 id="-31问题描述"><a id="3_1"></a> 3.1、问题描述</h3>

<p>开发中遇到有人使用 YYYY-MM-dd 处理时间格式，觉得不对又说不出为什么，就调研了一下。</p>

<p>大多数情况下，设置时间格式 YYYY-MM-dd 和 yyyy-MM-dd 转换的日期是一样的，只有当到达一些特点的时间节点，跨年时使用 “YYYY-MM-dd” 可能会出现差一年的问题。如下代码所示：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 原始的日期字符串</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">orginDateStr</span> <span class="o">=</span> <span class="s">@"2015-12-28"</span><span class="p">;</span>
<span class="c1">// 转换为NSDate</span>
<span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">orginFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">orginFormatter</span> <span class="nf">setDateFormat</span><span class="p">:</span><span class="s">@"yyyy-MM-dd"</span><span class="p">];</span>
<span class="n">NSDate</span> <span class="o">*</span> <span class="n">orginDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">orginFormatter</span> <span class="nf">dateFromString</span><span class="p">:</span><span class="n">orginDateStr</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"orginFormatter: orginDate is %@"</span><span class="p">,</span> <span class="n">orginDate</span><span class="p">);</span>

<span class="c1">// 如果用YYYY将orginDate转换回字符串时就出现了问题</span>
<span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">weekFormatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="p">[</span><span class="n">weekFormatter</span> <span class="nf">setDateFormat</span><span class="p">:</span><span class="s">@"YYYY-MM-dd"</span><span class="p">];</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">weekDateStr</span> <span class="o">=</span> <span class="p">[</span><span class="n">weekFormatter</span> <span class="nf">stringFromDate</span><span class="p">:</span><span class="n">orginDate</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"weekFormatter: weekDateStr is %@"</span><span class="p">,</span> <span class="n">weekDateStr</span><span class="p">);</span>  
</code></pre></div></div>

<blockquote>
  <p>打印结果，相差一年：</p>

  <p>orginFormatter: orginDate is Mon Dec 28 00:00:00 2015</p>

  <p>weekFormatter: weekDateStr is 2016-12-28</p>
</blockquote>

<h3 id="-32问题分析"><a id="3_2"></a> 3.2、问题分析</h3>

<p>我们先来理解 YYYY 和 yyyy 的区别：</p>

<p>“YYYY format” 是 “ISO week numbering system”</p>

<p>“yyyy format” 是 “Gregorian Calendar（公历）”</p>

<p>“YYYY specifies the week of the year (ISO) while yyyy specifies the calendar year (Gregorian)”</p>

<p>yyyy specifies the calendar year whereas YYYY specifies the year (of “Week of Year”), used in the ISO year-week calendar.</p>

<p>也就是说转换为日期时，DateFormatter如果是YYYY格式的话，如果1月1日是星期一，星期二，星期三或星期四，它是在01周。如果一月1日是星期五，星期六或星期日，它在前一年的52周或53周。</p>

<p>苹果官方文档说使用YYYY是常见错误，正确的应该是使用yyyy格式，官方文档解释如下：</p>

<blockquote>
  <p>It uses yyyy to specify the year component. A common mistake is to use YYYY. yyyy specifies the calendar year whereas YYYY specifies the year (of “Week of Year”), used in the ISO year-week calendar. In most cases, yyyy and YYYY yield the same number, however they may be different. Typically you should use the calendar year.</p>

  <p>The representation of the time may be 13:00. In iOS, however, if the user has switched 24-Hour Time to Off, the time may be 1:00 pm.</p>
</blockquote>

<h3 id="-33解决方案"><a id="3_3"></a> 3.3、解决方案</h3>

<p>使用正确的时间格式 <strong>yyyy-MM-dd</strong> 来处理日期时间。</p>

<h2 id="-四ios-局部-bool-变量随机值"><a id="4_0"></a> 四、iOS 局部 BOOL 变量随机值</h2>

<h3 id="-41问题描述"><a id="4_1"></a> 4.1、问题描述</h3>

<p>测试给一个小伙伴提了一个Bug，点击一个功能时会不定时出现问题，能够复现，但不是每次都出现。如下代码所示：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">isSuccess</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isSuccess</span><span class="p">)</span> <span class="p">{</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"success"</span><span class="p">);</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"failed"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>测试结果：在 Debug 环境下真机和模拟器都是 failed，但打包成出来安装后可能为 success 也可能是 failed 了。</p>

<h3 id="-42问题分析"><a id="4_2"></a> 4.2、问题分析</h3>

<p>很明显是局部变量 isSuccess 出现了随机值导致的，虽然我个人平时的习惯是声明遍历一定会初始化，但 Debug 模式下正常，打包后就出现随机值的原因还是不清楚，于是调研了一下。</p>

<p>在 ARC 环境下，本地对象创建如果未初始化，指针会指向默认值 nil；但是类似 BOOL 的非对象类型的局部变量，未初始化时会指向最后一次写入该地址的内容，可能为任意值，也就是垃圾值，出现随机值也就不稀奇了。</p>

<h3 id="-43解决方案"><a id="4_3"></a> 4.3、解决方案</h3>

<p>创建变量时要养成初始化的好习惯，尤其是基本数据类型，例如:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">isSuccess</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span> 
<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="-五iphone-用户名包含特殊符号引起的后台-crash"><a id="5_0"></a> 五、iPhone 用户名包含特殊符号引起的后台 Crash</h2>

<h3 id="-51问题描述"><a id="5_1"></a> 5.1、问题描述</h3>

<p>遇到一个工单，客户反馈无法正常进入 App，进入后就报错，还反馈了机型、系统版本，App 版本等信息。</p>

<p>排查代码逻辑没有问题，找到相同系统的机型，相同 App 版本测试没有问题。</p>

<p>期间也回复了用户软件没有问题，但这个用户锲而不舍，最终给这个用户发了一个 Debug 版本，报错时 Debug 日志展示在界面上，复制粘贴发过来。最终问题定位在了<strong>用户名</strong>上面，这位用户的用户名类似于这样的 &amp;&amp;###???###&amp;&amp;。</p>

<h3 id="-52问题分析"><a id="5_2"></a> 5.2、问题分析</h3>

<p>这时候可能已经想明白怎么回事了，特殊符号转义引起的后台Bug。例如一些特殊的符号，例如 !#$&amp;’()*+,/:;=?@[] 这些特殊符号，拼接在 URL 或者 Body 里面，传送到后台时都可能引起转义，不能正常解析，不同的后台表现逻辑不一致。</p>

<h3 id="-53解决方案"><a id="5_3"></a> 5.3、解决方案</h3>

<p>既然是特殊字符引起的，在网络传输过程中，对特殊字符进 URLEncode 即可，服务器接收到进行 URLDecode 即可。</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 用户手机设置的用户名</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">userPhoneName</span> <span class="o">=</span> <span class="s">@"abc&amp;&amp;&amp;???dd**%###!!!"</span><span class="p">;</span>

<span class="c1">// 设置需要转义的特殊字符，例如@"/+=\n"</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">characterSetStr</span> <span class="o">=</span> <span class="s">@"?!@#$^&amp;%*+,:;='</span><span class="se">\"</span><span class="s">`&lt;&gt;()[]{}/</span><span class="se">\\</span><span class="s">| "</span><span class="p">;</span>
<span class="n">NSCharacterSet</span> <span class="o">*</span><span class="n">characterSet</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSCharacterSet</span> <span class="nf">characterSetWithCharactersInString</span><span class="p">:</span><span class="n">characterSetStr</span><span class="p">]</span> <span class="nf">invertedSet</span><span class="p">];</span>
<span class="c1">// 返回转义后的字符串</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">urlEncodeStr</span> <span class="o">=</span> <span class="p">[</span><span class="n">userPhoneName</span> <span class="nf">stringByAddingPercentEncodingWithAllowedCharacters</span><span class="p">:</span><span class="n">characterSet</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"UserPhoneName Encoding is %@"</span><span class="p">,</span><span class="n">urlEncodeStr</span><span class="p">);</span>

<span class="c1">// 移除百分号转义</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">removeEncodingStr</span> <span class="o">=</span> <span class="n">urlEncodeStr</span><span class="p">.</span><span class="n">stringByRemovingPercentEncoding</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"UserPhoneName removeEncoding is %@"</span><span class="p">,</span><span class="n">removeEncodingStr</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>打印结果：</p>

  <p>UserPhoneName Encoding is abc%26%26%26%3F%3F%3Fdd%2A%2A%25%23%23%23%21%21%21</p>

  <p>UserPhoneName removeEncoding is abc&amp;&amp;&amp;???dd**%###!!!</p>
</blockquote>

<p><strong>备注：</strong> 经历这次事件，在处理特殊字符问题上留下了深刻的印象，无论是处理用户输入，还是取值用户字符串，都会注意特殊字符的转义问题了。</p>

<h2 id="-六参考链接"><a id="6_0"></a> 六、参考链接</h2>

<p>https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/DataFormatting/Articles/dfDateFormatting10_4.html</p>

<p>http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/#jtss-tsina</p>


  </section>
</article>

<section>

    <div style="text-align:center;margin:50px 0; font:normal 14px/24px 'MicroSoft YaHei';"></div>

    <ul class="pager">
        
        <li class="previous">
            <a href="/2018/07/cocoapods-%E5%8F%91%E5%B8%83%E5%BA%93/" data-toggle="tooltip"
                data-placement="top" title="cocoapods 发布库">上一篇： <span>cocoapods 发布库</span>
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2018/11/%E8%87%AA%E5%BB%BA%E5%B1%80%E5%9F%9F%E7%BD%91-OTA-%E6%9C%8D%E5%8A%A1%E5%99%A8/" data-toggle="tooltip"
                data-placement="top" title="自建局域网 OTA 服务器">下一篇： <span>自建局域网 OTA 服务器</span>
            </a>
        </li>
        
    </ul>
</section>
<section class="post-comments">

</section>


            <section class="footer">
    <footer>
        <div class = "footer_div">
            <nav class="cover-navigation navigation--social">
                <ul class="navigation">
                    
                    
                    <!-- Github -->
                    <li class="navigation__item_social">
                        <a href="https://github.com/muzipiao" title="@muzipiao 的 Github" target="_blank">
                            <div class="footer-social-icon" style="background-image:url(/images/github.png);"></div>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    <!-- Zhihu -->
                    <li class="navigation__item_social">
                        <a href="https://juejin.im/user/5b2f1c51f265da59ad439f69" title="@5b2f1c51f265da59ad439f69" target="_blank">
                            <div class="footer-social-icon" style="background-image:url(/images/juejin.png);"></div>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <!-- Email -->
                    <li class="navigation__item_social">
                        <a href="mailto:lifei_zdjl@126.com" title="Contact me">
                            <div class="footer-social-icon" style="background-image:url(/images/email.png);"></div>
                        </a>
                    </li>
                    
                    
                    <!-- RSS -->
                    <li class="navigation__item_social">
                        <a href="/feed.xml" rel="author" title="RSS" target="_blank">
                            <div class="footer-social-icon" style="background-image:url(/images/rss.png);"></div>
                            <span class="label">RSS</span>
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </div>
        <div><br><br></div>
        <div class="footer__copyright" >
            <br>
            <span>©2020&nbsp;cocoafei&nbsp;</span>
            <img src="/images/beian.png"/>
            <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010702002032" target="_blank">京公网安备 11010702002032号</a>
            <span>&nbsp;</span>
            <a href="http://beian.miit.gov.cn/" target="_blank">京ICP备2020033870号</a>
        </div>
    </footer>
</section>

        </div>
    </div>
    
    <script type="text/javascript" src="//libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>

</html>
