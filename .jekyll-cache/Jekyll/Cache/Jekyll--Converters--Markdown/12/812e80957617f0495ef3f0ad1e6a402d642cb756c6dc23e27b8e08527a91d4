I"(ê<h2 id="è‡ªåŠ¨æ‰«ææ¦‚è¿°">è‡ªåŠ¨æ‰«ææ¦‚è¿°</h2>

<p>SonarQube æ˜¯ä¸€æ¬¾ç”¨äºä»£ç è´¨é‡ç®¡ç†çš„å¼€æºå·¥å…·ï¼Œå®ƒä¸»è¦ç”¨äºç®¡ç†æºä»£ç çš„è´¨é‡ã€‚SonarQube å…¨è‡ªåŠ¨åŒ–æ‰«æï¼Œä¸»è¦åˆ©ç”¨ Jenkins æ£€æµ‹ Git ä»£ç æ›´æ–°ï¼Œå®šæ—¶æ‹‰å–ä»£ç ï¼Œç„¶åé…åˆ oclint åŠ SonarQube å®ç°è‡ªåŠ¨åŒ–æ‰«æå±•ç¤ºã€‚oclint è´Ÿè´£æ‰«æé¡¹ç›®ï¼ŒSonarQube è´Ÿè´£å°†æ‰«æç»“æœå­˜å‚¨åˆ°æ•°æ®åº“ï¼Œå¹¶æä¾›æ•°æ®å¯è§†åŒ–ã€‚</p>

<p><img src="/images/posts/sonar/sonar_swift.png" alt="SonarQube" /></p>

<h2 id="ä¸»è¦æ­¥éª¤">ä¸»è¦æ­¥éª¤</h2>

<ol>
  <li>Jenkins å®šæ—¶æ£€æµ‹ Git åˆ†æ”¯æ›´æ–°ï¼Œå¹¶æ‰§è¡Œè„šæœ¬ï¼ˆåªæœ‰æ­¤æ“ä½œä½¿ç”¨ Jenkinsï¼Œä»¥ä¸‹æ­¥éª¤ä½¿ç”¨è„šæœ¬ï¼‰ï¼›</li>
  <li>è„šæœ¬æ£€æµ‹æœ¬åœ°æ˜¯å¦å·²å­˜åœ¨é¡¹ç›®ï¼Œä¸å­˜åœ¨<code class="language-plaintext highlighter-rouge">git clone</code>æ‹‰å–ä»£ç ï¼Œå­˜åœ¨<code class="language-plaintext highlighter-rouge">git pull</code>æ‹‰å–æ›´æ–°åˆ°æœ¬åœ°ï¼›</li>
  <li>æŸ¥æ‰¾å®šä½åç¼€ä¸º<code class="language-plaintext highlighter-rouge">.xcodeproj</code>çš„å·¥ç¨‹æ–‡ä»¶ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">xcodebuild -list</code>è·å– Schemes åˆ—è¡¨ï¼›</li>
  <li>ä½¿ç”¨ xcodebuild æ¸…ç†å·¥ç¨‹ç¼“å­˜ï¼Œå¹¶ç”Ÿæˆæ–°çš„ç¼–è¯‘æ•°æ®ï¼Œä½¿ç”¨ xcpretty è½¬æˆ json æ ¼å¼ï¼›</li>
  <li>ä½¿ç”¨ oclint è®¾ç½®ç›¸å…³å¿½ç•¥é¡¹ï¼Œå¹¶å¯¼å‡º oclint.xml æ ¼å¼åˆ†ææŠ¥å‘Šï¼›</li>
  <li>è„šæœ¬åŠ¨æ€ç”Ÿæˆ sonar-project.properties æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨ sonar-scanner å‚¨å­˜åˆ°æ•°æ®åº“ï¼›</li>
  <li>å¯¼å‡º ~/.jenkins/jobs/ ç›®å½•ä¸‹çš„ config.xml æ¨¡æ¿æ–‡ä»¶ï¼Œè„šæœ¬æ‰¹é‡åˆ›å»ºæ·»åŠ ä»»åŠ¡ï¼›</li>
  <li>æ‰‹åŠ¨æˆ– Jenkins è‡ªåŠ¨è§¦å‘æ‰«æï¼Œæœ¬æœºè®¿é—® <code class="language-plaintext highlighter-rouge">http://localhost:9000</code> æŸ¥çœ‹ç»“æœã€‚</li>
</ol>

<h2 id="å®‰è£…æµç¨‹">å®‰è£…æµç¨‹</h2>

<ol>
  <li>å®˜ç½‘ä¸‹è½½ dmg å®‰è£… Java 8ï¼ŒJenkins ä¾èµ– Java 8ï¼Œå¤šç‰ˆæœ¬å¯å…±å­˜ã€‚</li>
  <li>å®‰è£… Jenkins å’Œç›¸å…³ Git ç»„ä»¶ï¼Œbrew å®‰è£…å¤±è´¥å¯è¿…é›·ä¸‹è½½æ›¿æ¢ï¼Œæ’ä»¶å®‰è£…å¤±è´¥å¯æ¢æºæ¢ç½‘ã€‚</li>
  <li>brew å®‰è£… postgresqlï¼Œå¹¶åˆ›å»ºæ•°æ®åº“åã€è¡¨åã€ç”¨æˆ·åå’Œå¯†ç ä¸º sonar çš„æ•°æ®åº“ã€‚</li>
  <li>ä¸‹è½½ sonarqube å®ç°å¯è§†åŒ–ï¼Œæ”¾åœ¨ /opt æˆ–å…¶ä»–ç›®å½•ä¸‹ï¼Œé…ç½® sonar.properties æ–‡ä»¶ã€‚</li>
  <li>ä¸‹è½½ sonar-swift ä¸‰æ–¹æ’ä»¶ï¼Œå°†æ’ä»¶æ”¾åœ¨ sonarqube çš„ plugins ç›®å½•ä¸‹ã€‚</li>
  <li>å®‰è£… sonar-scanner å¹¶é…ç½® sonar-scanner.properties æ–‡ä»¶çš„ URL å’Œç¼–ç ã€‚</li>
  <li>é…ç½® Jenkins çš„ jobs ä»»åŠ¡å’Œ shell è¿è¡Œã€‚</li>
</ol>

<h2 id="java-å®‰è£…">Java å®‰è£…</h2>

<p>è®¿é—® <a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">Javaå®˜ç½‘</a>ï¼Œå¹¶ä¸‹è½½ Java 8 ç‰ˆæœ¬çš„ dmg å®‰è£…åŒ…ï¼ŒåŒå‡»å®‰è£…å³å¯ã€‚æ³¨æ„ï¼Œä¸è¦ä»…å®‰è£…æœ€æ–°ç‰ˆæœ¬ JDKï¼ŒJenkins è¦æ±‚ Java 8ï¼Œå¦‚æœéœ€è¦å¯ä»¥åŒæ—¶å®‰è£…å¤šç‰ˆæœ¬ Javaã€‚</p>

<p>è‹¥éœ€è¦å®Œå…¨åˆ é™¤æ—§çš„ Java ç‰ˆæœ¬ï¼Œå¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å’Œæ“ä½œã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo rm</span> <span class="nt">-fr</span> /Library/Internet<span class="se">\ </span>Plug-Ins/JavaAppletPlugin.plugin
<span class="nb">sudo rm</span> <span class="nt">-fr</span> /Library/PreferencePanes/JavaControlPanel.prefPane
<span class="nb">sudo rm</span> <span class="nt">-fr</span> ~/Library/Application<span class="se">\ </span>Support/Oracle/Java
</code></pre></div></div>

<p>å¹¶åœ¨ /Library/Java/JavaVirtualMachines/ ç›®å½•ä¸‹åˆ é™¤å¯¹åº” Java ç‰ˆæœ¬ç¼“å­˜ã€‚</p>

<h2 id="jenkins-å®‰è£…">Jenkins å®‰è£…</h2>

<p><strong>ç½‘ç»œä¸Šå®‰è£…æ•™ç¨‹å¾ˆå¤šï¼Œä¸å†è¯¦ç»†èµ˜è¿°ï¼Œä»…è¯´æ˜ç®€è¦æ­¥éª¤ã€‚</strong></p>

<ol>
  <li>ä½¿ç”¨ brew å®‰è£…ç®€å•ï¼Œæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">brew install jenkins</code>å®‰è£…ï¼Œç»ˆç«¯æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">jenkins</code> å¯åŠ¨ï¼›</li>
  <li>å¯åŠ¨å®Œæˆï¼Œæµè§ˆå™¨è¾“å…¥<code class="language-plaintext highlighter-rouge">localhost:8080</code>æµè§ˆï¼Œè¿›å…¥ Jenkins ç®¡ç†ç½‘é¡µï¼›</li>
  <li>é¦–æ¬¡ä¼šæç¤ºè¾“å…¥åˆå§‹å¯†ç ï¼Œè‹¥æ— æç¤ºå¯åœ¨<code class="language-plaintext highlighter-rouge">~/.jenkins/secrets/initialAdminPassword</code>è·¯å¾„æ‰¾åˆ°ï¼›</li>
  <li>æ ¹æ®æç¤ºè¾“å…¥åˆå§‹å¯†ç ï¼Œå¹¶åˆ›å»ºç”¨æˆ·åå’Œå¯†ç ï¼Œä¾‹å¦‚é€‰æ‹©è´¦æˆ·åå’Œå¯†ç éƒ½æ˜¯ sonarï¼›</li>
  <li>åœ¨ Jenkins ç³»ç»Ÿè®¾ç½®-æ’ä»¶ç®¡ç†ä¸­ï¼Œé€‰æ‹© Git å’Œ Xcode ç­‰ç›¸å…³æ’ä»¶ï¼›</li>
  <li>é€‰æ‹© æ–°å»º-è‡ªç”±é£æ ¼é¡¹ç›®ï¼ŒæŒ‰ç…§æç¤ºé…ç½® Git å’Œ Shell è„šæœ¬å³å¯ã€‚</li>
</ol>

<p><strong>ä½¿ç”¨ brew å®‰è£… Jenkins å¤±è´¥ï¼Œå¯æ‰‹åŠ¨å®‰è£…ï¼Œè¿…é›·ä¸‹è½½ï¼Œæ‰‹åŠ¨å¤åˆ¶åˆ°æŒ‡å®šç›®å½•ä¸‹ã€‚</strong></p>

<ol>
  <li>brew install xxxx å¤±è´¥æ—¶è¿”å›å¯¹åº” xxxx.tar.gz çš„é“¾æ¥ï¼Œè¿…é›·ä¸‹è½½ï¼›</li>
  <li>brew â€“cache æŸ¥çœ‹ç¼“å­˜(/Users/lif/Library/Caches/Homebrew);</li>
  <li>ç‚¹å‡»ä»»æ„é“¾æ¥ï¼Œæ˜¾ç¤ºåŸèº«æ‰¾åˆ°ä¸‹è½½ç›®å½•<code class="language-plaintext highlighter-rouge">~/Library/Caches/Homebrew/downloads/</code>;</li>
  <li>å°†ä¸‹è½½çš„ xxxx.tar.gz æ‹·è´åˆ°ä¸‹è½½ç›®å½•ï¼Œåç§°å‘½åä¸ºå’Œ .tar.gz.incomplete åŒæ ·åç§°ï¼Œå»æ‰ .incomplete;</li>
  <li>å†æ¬¡å®‰è£… brew install xxxxã€‚</li>
</ol>

<p><strong>Jenkins å¦‚æœå®‰è£…æ’ä»¶å¤±è´¥ï¼Œå¯ä»¥æ›´æ¢å®‰è£…æºã€æ‰‹åŠ¨ä¸Šä¼ ã€ç§‘å­¦è®¿é—®å¤–ç½‘ï¼Œæ›´æ¢ç½‘ç»œã€‚</strong></p>

<ol>
  <li>æ›´æ¢å®‰è£…æºè·¯å¾„åœ¨ Jenkins çš„ç®¡ç†ç½‘é¡µä¸­ï¼Œç³»ç»Ÿè®¾ç½®-æ’ä»¶ç®¡ç†-é«˜çº§-ä¿®æ”¹å‡çº§ç«™ç‚¹ã€‚
eg.å®‰è£…æºï¼šhttp://mirror.esuni.jp/jenkins/updates/update-center.json</li>
  <li>å®˜ç½‘ä¸‹è½½åç¼€ .hpi æ’ä»¶æ–‡ä»¶ï¼Œåœ¨ç³»ç»Ÿè®¾ç½®-æ’ä»¶ç®¡ç†-é«˜çº§-ä¸Šä¼ æ’ä»¶ï¼Œé€‰æ‹©ä¸‹è½½çš„æ’ä»¶ä¸Šä¼ ã€‚
eg.Jenkins æ’ä»¶å®˜ç½‘ï¼šhttps://plugins.jenkins.io/</li>
  <li>ç§‘å­¦è®¿é—®å¤–ç½‘ï¼Œå¯ä»¥é€‰æ‹©ç§‘å­¦è®¿é—®å¤–ç½‘ä¸‹è½½ã€‚</li>
  <li>ä¸‹è½½å¤±è´¥ä¹Ÿå¯èƒ½æ˜¯è¿æ¥ç½‘ç»œçš„é—®é¢˜ï¼Œæˆ‘ä½¿ç”¨å…¬å¸ç½‘ç»œæ— è®ºå¦‚ä½•éƒ½æ˜¯å¤±è´¥ï¼Œä½¿ç”¨æ‰‹æœºåˆ†äº« WiFi ä¸‹è½½æˆåŠŸã€‚</li>
</ol>

<p><strong>Jenkins å¯åŠ¨åœæ­¢</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¯åŠ¨ jenkinsï¼ŒCtrl + C å¼ºåˆ¶ç»ˆæ­¢</span>
jenkins
<span class="c"># brew å¯åŠ¨ jenkins æœåŠ¡çš„æ–¹å¼ï¼ˆæ³¨æ„æ­¤æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ‰§è¡Œ Shell å­˜åœ¨ç”¨æˆ·æƒé™é—®é¢˜ï¼‰</span>
brew services restart jenkins
<span class="c"># brew åœæ­¢ jenkins æœåŠ¡çš„æ–¹å¼</span>
brew services stop jenkins
</code></pre></div></div>
<p>æ³¨æ„ï¼šä½¿ç”¨æ­¤æ–¹å¼å¯åŠ¨å¯èƒ½å¯¼è‡´æ‰§è¡Œ Shell è„šæœ¬å¤±è´¥ï¼Œè‹¥å¤±è´¥å¯ä»¥åœ¨ç»ˆç«¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">jenkins</code>å‘½ä»¤å¯åŠ¨ã€‚</p>

<p>ç½‘é¡µå¯åŠ¨/åœæ­¢/é‡å¯æœåŠ¡ï¼š</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="nb">exit</span> <span class="sr">//</span><span class="err">åœæ­¢æœåŠ¡</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">restart</span> <span class="sr">//</span><span class="err">é‡å¯æœåŠ¡</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">reload</span> <span class="sr">//</span> <span class="err">é‡æ–°è½½å…¥æœåŠ¡</span>
</code></pre></div></div>

<h2 id="postgresql">postgresql</h2>

<p>sonarqube é»˜è®¤æ•°æ®åº“ä¸º h2ï¼Œç”¨äºæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ sonarqube çš„å®‰è£…ç›®å½• conf/sonar.properties æ–‡ä»¶ä¸­æ‰¾åˆ°æ”¯æŒçš„æ•°æ®åº“çš„è¯´æ˜ï¼Œpostgresql å°±æ˜¯æ”¯æŒçš„ä¸€ç§ã€‚</p>

<blockquote>
  <p>The embedded H2 database is used by default. It is recommended for tests but not for production use. Supported databases are Oracle, PostgreSQL and Microsoft SQLServer.</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å®‰è£…</span>
brew <span class="nb">install </span>postgresql
<span class="c"># åˆå§‹åŒ–ï¼Œå¯çœç•¥</span>
initdb /usr/local/var/postgres
<span class="c"># å¯åŠ¨æœåŠ¡</span>
pg_ctl <span class="nt">-D</span> /usr/local/var/postgres <span class="nt">-l</span> /usr/local/var/postgres/server.log start
<span class="c"># è®¾ç½®å¼€æœºå¯åŠ¨ï¼ˆæ­¤æ“ä½œä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·æƒé™é—®é¢˜ï¼Œå¯¼è‡´ sonarqube å¯åŠ¨å¤±è´¥ï¼‰</span>
<span class="nb">ln</span> <span class="nt">-sfv</span> /usr/local/opt/postgresql/<span class="k">*</span>.plist ~/Library/LaunchAgents
launchctl load ~/Library/LaunchAgents/homebrew.mxcl.postgresql.plist
<span class="c"># ç»™å½“å‰ç”¨æˆ·åˆ›å»ºæ•°æ®åº“ï¼Œpostgres ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ï¼Œéœ€æ‰‹åŠ¨åˆ›å»º</span>
createdb
<span class="c"># åˆ›å»ºç”¨æˆ·</span>
CREATE USER sonar WITH PASSWORD <span class="s1">'sonar'</span><span class="p">;</span>
<span class="c"># åˆ›å»ºæ•°æ®åº“</span>
CREATE DATABASE sonar WITH OWNER sonar ENCODING <span class="s1">'UTF8'</span><span class="p">;</span>
<span class="c"># ç»™ sonar ç”¨æˆ·æ·»åŠ åˆ›å»ºæ•°æ®åº“çš„å±æ€§</span>
ALTER ROLE sonar CREATEDB<span class="p">;</span>
<span class="c"># æµ‹è¯•å½“å‰ç”¨æˆ·</span>
psql <span class="nt">-U</span> sonar <span class="nt">-W</span>
<span class="c"># ç™»å½•æ§åˆ¶å°</span>
psql
<span class="c"># åˆ é™¤æ•°æ®åº“ï¼ˆå¤‡ç”¨ï¼‰</span>
DROP DATABASE sonar<span class="p">;</span>
<span class="c"># æ‰€æœ‰æƒåŠæ‰€æœ‰æƒè½¬æ¢ï¼ˆå¤‡ç”¨ï¼‰</span>
CREATE DATABASE sonar OWNER sonar<span class="p">;</span>
GRANT ALL PRIVILEGES ON DATABASE sonar to sonar<span class="p">;</span>
</code></pre></div></div>

<h2 id="sonarqube">sonarqube</h2>

<p>ä¸‹è½½ <a href="https://www.sonarqube.org/downloads/">sonarqube</a> æºç åˆ°æŒ‡å®šç›®å½•ï¼Œä¾‹å¦‚å¯æ”¾åœ¨ /opt æˆ–å…¶ä»–ç›®å½•ä¸‹ï¼Œåˆå§‹è´¦å·å¯†ç  adminã€‚é…ç½® conf/sonar.properties æ–‡ä»¶ä¸­çš„æ•°æ®åº“è´¦å·ã€å¯†ç å’Œ URLã€‚</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sonar</span><span class="p">.</span><span class="nf">jdbc</span><span class="p">.</span><span class="nf">username</span><span class="o">=</span><span class="n">sonar</span>
<span class="n">sonar</span><span class="p">.</span><span class="nf">jdbc</span><span class="p">.</span><span class="nf">password</span><span class="o">=</span><span class="n">sonar</span>
<span class="n">sonar</span><span class="p">.</span><span class="nf">jdbc</span><span class="p">.</span><span class="nf">url</span><span class="o">=</span><span class="n">jdbc</span><span class="ss">:postgresql:/</span><span class="o">/</span><span class="n">localhost</span><span class="o">/</span><span class="n">sonar</span>
</code></pre></div></div>

<p>å¯åŠ¨æ–¹å¼ä¸ºæ‰§è¡Œå®‰è£…ç›®å½•ä¸‹å¯¹åº”ç³»ç»Ÿçš„ shell æ–‡ä»¶ï¼Œä¾‹å¦‚æˆ‘çš„ç”µè„‘ä¸º Macï¼Œsonarqube æ”¾åœ¨ /opt ç›®å½•ä¸‹ï¼Œå¯ä»¥æ‰§è¡Œ bin ç›®å½•ä¸‹çš„ macosx-universal-64/sonar.sh è„šæœ¬å¯åŠ¨ã€‚æ³¨æ„ /opt ä¸º Mac ç³»ç»Ÿéšè—æ ¹ç›®å½•ï¼ŒåŒæ—¶æŒ‰ <code class="language-plaintext highlighter-rouge">command shift = .</code> å››ä¸ªæŒ‰é”®å¯ä»¥æ˜¾ç¤ºç³»ç»Ÿéšè—æ–‡ä»¶ï¼Œå†æŒ‰ä¸€æ¬¡éšè—ç³»ç»Ÿéšè—æ–‡ä»¶ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¯åŠ¨ sonarqube</span>
sh /opt/sonarqube/bin/macosx-universal-64/sonar.sh start
<span class="c"># å¦‚æœæ‰§è¡Œ shell å­˜åœ¨æƒé™é—®é¢˜ï¼Œå¯ä½¿ç”¨ chmod 777 è·å–å¯¹åº”æ–‡ä»¶æˆ–ç›®å½•ç³»ç»Ÿæƒé™</span>
<span class="nb">chmod </span>777 /opt/sonarqube/bin/macosx-universal-64/sonar.sh
<span class="c"># è·å–ç›®å½• /opt ç³»ç»Ÿæƒé™</span>
<span class="nb">sudo chmod</span> <span class="nt">-R</span> 777 /opt
</code></pre></div></div>

<h2 id="å®‰è£…-sonar-swift-æ’ä»¶">å®‰è£… sonar-swift æ’ä»¶</h2>

<p>ç”±äº sonarqube çš„ ObjectiveC æ’ä»¶æ”¶è´¹ï¼Œä½¿ç”¨ä¸‰æ–¹æ’ä»¶<a href="https://github.com/Backelite/sonar-swift">sonar-swift</a>ï¼Œå¹¶æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®‰è£…ç›¸å…³æ’ä»¶ï¼Œå°†ä¸‹è½½çš„ .jar åŒ…æ”¾åœ¨ sonarqubeçš„ extensions/plugins ç›®å½•ä¸‹ã€‚æ—§ç‰ˆæ’ä»¶ sonar-objective-c å·²ä¸æ”¯æŒæœ€æ–°ç‰ˆ sonarqubeï¼Œè€Œ sonar-swift åŒæ—¶æ”¯æŒ swift å’Œ objective-cã€‚</p>

<p>sonar-swift è¦æ±‚å®‰è£…çš„æ’ä»¶è¾ƒå¤šï¼Œå¯ä»¥é€‰æ‹©å®‰è£… sonar-scannerï¼Œoclint å’Œ xcprettyã€‚</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">brew</span> <span class="n">install</span> <span class="n">swiftlint</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">tailor</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">sonar</span><span class="o">-</span><span class="n">scanner</span>
<span class="c1"># å®‰è£… oclint</span>
<span class="n">brew</span> <span class="n">tap</span> <span class="n">oclint</span><span class="o">/</span><span class="n">formulae</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">oclint</span>
<span class="c1"># æ›´æ–° oclint</span>
<span class="n">brew</span> <span class="n">update</span>
<span class="n">brew</span> <span class="n">upgrade</span> <span class="n">oclint</span>
<span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">xcpretty</span>
<span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">slather</span>
<span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">lizard</span>
</code></pre></div></div>

<p>sonar-scanner å®‰è£…å®Œæˆåéœ€è¦é…ç½®ä¸€ä¸‹ï¼Œç»ˆç«¯è¾“å…¥<code class="language-plaintext highlighter-rouge">where sonar-scanner</code>ï¼Œæ‰¾åˆ°å®‰è£…è·¯å¾„ï¼ˆ/usr/local/Cellar/sonar-scanner/ï¼‰ï¼Œåœ¨ç›®å½•ä¸‹æ‰¾åˆ°é…ç½®æ–‡ä»¶ sonar-scanner.propertiesï¼Œé…ç½®æ‰«æç»“æœä¸Šä¼ åœ°å€å’Œç¼–ç ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># sonar-scanner æ‰«æç»“æœä¸Šä¼ åœ°å€ï¼ˆsonarqube åœ°å€ä¸º http://localhost:9000ï¼‰</span>
sonar.host.url<span class="o">=</span>http://localhost:9000
<span class="c"># ç¼–ç æ ¼å¼</span>
sonar.sourceEncoding<span class="o">=</span>UTF-8
</code></pre></div></div>

<h2 id="å¯åŠ¨æ‰«æ">å¯åŠ¨æ‰«æ</h2>

<p>æ‰€æœ‰æ’ä»¶å·²å®‰è£…å®Œæ¯•ï¼Œå¯ä»¥æ‰§è¡Œ sonar-scan è¿›è¡Œ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¯åŠ¨postgresæœåŠ¡</span>
pg_ctl <span class="nt">-D</span> /usr/local/var/postgres <span class="nt">-l</span> /usr/local/var/postgres/server.log start
<span class="c"># å¯åŠ¨ Jenkins</span>
brew services start jenkins
<span class="c"># å¯åŠ¨ sonar</span>
<span class="nb">chmod </span>777 /opt/sonarqube/bin/macosx-universal-64/sonar.sh
sh /opt/sonarqube/bin/macosx-universal-64/sonar.sh start
<span class="c"># Jenkins æ‰§è¡Œçš„è„šæœ¬ï¼Œè‡ªåŠ¨æ‹‰å–åˆ†æ”¯ä»£ç ï¼Œåˆ†æï¼Œä¸Šä¼  sonarï¼Œä¼ å…¥æœ¬åœ°ä»“åº“åœ°å€å’Œ Git åœ°å€å³å¯</span>
/usr/bin/python /Users/lf/Documents/auto-scanner/auto-sonar.py publicplugingoup/gbcheckup.git
</code></pre></div></div>

<p>åŸç†å¾ˆç®€å•ï¼Œåˆ›å»ºä¸€ä¸ª jenkins ä»»åŠ¡ï¼Œå®šæ—¶æ£€æŸ¥æ›´æ–°ï¼Œå¦‚æœæœ‰æ›´æ–°ï¼Œå°±æ‰§è¡Œè„šæœ¬å»æ‹‰å–ä»£ç ï¼Œå¹¶æ‰«æä¸Šä¼ ç»“æœã€‚
ä¾‹å¦‚éœ€è¦å°†æ‰€æœ‰åˆ†æ”¯ä¿å­˜åˆ°å½“å‰ç”¨æˆ·æ¡Œé¢çš„ Git æ–‡ä»¶å¤¹ä¸‹ï¼Œé‚£ä»“åº“è·¯å¾„å°±æ˜¯<code class="language-plaintext highlighter-rouge">~/Desktop/Git</code>ï¼Œåˆ†æ”¯çš„ Git åœ°å€ä¸º http://192.168.1.88/app/mybranch.gitï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬ä¸‹è½½æ‰«æã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/python /Users/lf/Documents/auto-scanner/auto-sonar.py publicplugingoup/gbcheckup.git
</code></pre></div></div>

<h4 id="è‡ªåŠ¨åŒ–æ‰«æ">è‡ªåŠ¨åŒ–æ‰«æ</h4>

<p>å®Œæˆä¸Šé¢æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä¸ºæ¯ä¸ªä»“åº“è¿›è¡Œæ‰«æï¼Œé‚£å¦‚ä½•åšåˆ°å¦‚ä¸‹è‡ªåŠ¨åŒ–è¦æ±‚ï¼š</p>

<ol>
  <li>æ‰¹é‡ä¸ºæ¯ä¸ªç»„ä»¶åˆ›å»º Jenkins ä»»åŠ¡ï¼Œå¹¶å®šæ—¶æ£€æµ‹ Git æ›´æ–°ï¼Œè‹¥æ›´æ–°åˆ™è‡ªåŠ¨æ‰«æï¼›</li>
  <li>ä½¿ç”¨è„šæœ¬è‡ªåŠ¨ä» Git æ‹‰å–ç»„ä»¶æºç ï¼Œè‹¥å·²æ‹‰å–åˆ™æ£€æŸ¥æ›´æ–°ç»„ä»¶ä»£ç ï¼›</li>
  <li>è‡ªåŠ¨æŸ¥æ‰¾å®šä½é¡¹ç›® project æ–‡ä»¶åŠé¡¹ç›® schemeï¼Œè‡ªåŠ¨è¿›è¡Œé€ä¸ªæ‰«æï¼›</li>
  <li>è‡ªåŠ¨åˆ›å»º Sonar é…ç½®æ–‡ä»¶ï¼Œæ‰«æç»“æœè‡ªåŠ¨å‚¨å­˜åˆ°æ•°æ®åº“ï¼Œé€šè¿‡ç½‘é¡µæŸ¥çœ‹ç»“æœã€‚</li>
</ol>

<p>æ‰¹é‡åˆ›å»º Jenkins ä»»åŠ¡ï¼Œæˆ‘ä»¬é€šè¿‡è„šæœ¬ä¸€æ¬¡æ€§æ‰¹é‡åˆ›å»ºå³å¯ï¼›æ£€æµ‹æ›´æ–°æˆ‘ä»¬å¯ä»¥é€šè¿‡ Jenkins å®šæ—¶ä»»åŠ¡å»æ‰§è¡Œï¼›è‡ªåŠ¨æ‹‰å–æœ€æ–°ä»£ç å’ŒæŸ¥æ‰¾ scheme è¿›è¡Œæ‰«æï¼Œæˆ‘ä»¬åœ¨å®šæ—¶ä»»åŠ¡çš„è„šæœ¬ä¸­æ‰§è¡Œå³å¯ã€‚</p>

<h2 id="jenkins-æ‰¹é‡åˆ›å»ºä»»åŠ¡">Jenkins æ‰¹é‡åˆ›å»ºä»»åŠ¡</h2>

<p>è‹¥ç»„ä»¶å¾ˆå¤šï¼Œé€ä¸ªæ‰‹åŠ¨åˆ›å»º Jenkins ä»»åŠ¡ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆç¨‹åºå‘˜çš„é£æ ¼ï¼Œæˆ‘ä»¬éœ€è¦æ‰¹é‡è‡ªåŠ¨åˆ›å»ºã€‚å‡è®¾æˆ‘ä»¬çš„ç»„ä»¶ Git åœ°å€éƒ½æ˜¯è¿™æ ·çš„</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.1.44/publicrepos/demo1.git
http://192.168.1.44/publicrepos/demo2.git
http://192.168.1.44/publicrepos/demo3.git
http://192.168.1.44/publicrepos/demo3.git
</code></pre></div></div>

<p>æˆ‘ä»¬ä¸ºåˆ†æ”¯ <code class="language-plaintext highlighter-rouge">http://192.168.1.44/publicrepos/demo1.git</code> åˆ›å»ºä¸€ä¸ª Jenkins çš„ä»»åŠ¡ï¼Œè¿™æ—¶æˆ‘ä»¬ä¼šå‘ç° <code class="language-plaintext highlighter-rouge">~/.jenkins/jobs/</code> ç›®å½•ä¸‹å¤šäº† demo1 æ–‡ä»¶å¤¹ï¼Œé‡Œé¢ config.xml æ–‡ä»¶ï¼Œè¿™å°±æ˜¯ Jenkins ä»»åŠ¡çš„é…ç½®ã€‚</p>

<p>é€šè¿‡å¯¹æ¯”æˆ‘ä»¬å‘ç°ï¼Œåªè¦ä¿®æ”¹ä¸€ä¸‹ Git åœ°å€å’Œä¼ å…¥è„šæœ¬çš„åˆ†æ”¯åç§°å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€ä¸ªç»„ä»¶å¤åˆ¶ä¸€ä»½ xml æ–‡æ¡£ï¼Œå¹¶ä¿®æ”¹ Git åœ°å€å’Œä¼ å…¥è„šæœ¬çš„å‚æ•°ï¼Œå¤åˆ¶åˆ° Mac ç«¯ Jenkins çš„ä»»åŠ¡ jobs è·¯å¾„ ~/.jenkins/jobs/ ä¸‹æ—¢å¯ã€‚</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version='1.1' encoding='UTF-8'?&gt;</span>
<span class="nt">&lt;project&gt;</span>
  <span class="c">&lt;!-- ......... çœç•¥éƒ¨åˆ† ........ --&gt;</span>
  <span class="nt">&lt;scm</span> <span class="na">class=</span><span class="s">"hudson.plugins.git.GitSCM"</span> <span class="na">plugin=</span><span class="s">"git@4.0.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;configVersion&gt;</span>2<span class="nt">&lt;/configVersion&gt;</span>
    <span class="nt">&lt;userRemoteConfigs&gt;</span>
      <span class="nt">&lt;hudson.plugins.git.UserRemoteConfig&gt;</span>
        <span class="c">&lt;!-- ç»„ä»¶çš„ Git åœ°å€ --&gt;</span>
        <span class="nt">&lt;url&gt;</span>http://192.168.1.44/publicrepos/demo1.git<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;credentialsId&gt;</span>31be0ffe-2c75-4183-9ab9-fd997a0942ea<span class="nt">&lt;/credentialsId&gt;</span>
      <span class="nt">&lt;/hudson.plugins.git.UserRemoteConfig&gt;</span>
    <span class="nt">&lt;/userRemoteConfigs&gt;</span>
  <span class="nt">&lt;/scm&gt;</span>
  <span class="nt">&lt;builders&gt;</span>
    <span class="nt">&lt;hudson.tasks.Shell&gt;</span>
      <span class="c">&lt;!-- æˆ‘ä»¬é…ç½®çš„æ‰§è¡Œ Shell è„šæœ¬å‘½ä»¤ --&gt;</span>
      <span class="nt">&lt;command&gt;</span>/usr/bin/python /Users/pk/Documents/auto-scanner/auto-sonar.py publicplugingoup/basemapcomponent.git<span class="nt">&lt;/command&gt;</span>
    <span class="nt">&lt;/hudson.tasks.Shell&gt;</span>
  <span class="nt">&lt;/builders&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<p>æ‰¹é‡ä¸ºæ¯ä¸ªç»„ä»¶åˆ›å»º Jenkins ä»»åŠ¡è„šæœ¬</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding=UTF-8
</span>
<span class="s">'''
g_old_branch åˆ›å»ºçš„æ¨¡æ¿æ–‡ä»¶ config.xml ä¸­éœ€è¦æ›¿æ¢çš„åˆ†æ”¯åç§°
g_old_time åˆ›å»ºçš„æ¨¡æ¿æ–‡ä»¶ config.xml ä¸­éœ€è¦æ›¿æ¢çš„è§¦å‘æ—¶é—´
git_links.txt ç»„ä»¶çš„ Git åœ°å€ï¼Œé€è¡Œåˆ†å¼€
config.xml æ‰‹åŠ¨åˆ›å»ºçš„ä¸€ä¸ª Jenkins ä»»åŠ¡å½“åšæ¨¡æ¿
æ‰¹é‡åˆ›å»ºå®Œæˆç»“æœåœ¨å½“å‰è„šæœ¬çš„ xmls æ–‡ä»¶å¤¹ä¸‹
'''</span>

<span class="n">g_old_branch</span> <span class="o">=</span> <span class="s">"publicplugingoup/basemapcomponent"</span>
<span class="n">g_old_time</span> <span class="o">=</span> <span class="s">"H(0-29)/19 * * * *"</span>

<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">re</span>

<span class="c1"># ä»URLè·å–åˆ†æ”¯åç§°ï¼Œeg. [publicplugingoup, basemapcomponent]
</span><span class="k">def</span> <span class="nf">get_branch</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
    <span class="n">link_list</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">link_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">branch_name_git</span> <span class="o">=</span> <span class="n">link_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">branch_group</span> <span class="o">=</span> <span class="n">link_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">branch_name_git</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">branch_group</span><span class="p">,</span> <span class="n">branch_name</span><span class="p">]</span>

<span class="c1"># é€è¡Œè¯»å–æ–‡ä»¶ä¸­çš„é“¾æ¥
</span><span class="k">def</span> <span class="nf">read_txt</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
    <span class="n">links_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># å‚¨å­˜è¡Œ
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_path</span><span class="p">):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s">""</span><span class="p">:</span>
            <span class="n">links_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">links_list</span>

<span class="c1"># æ ¹æ®å½“å‰ç´¢å¼•é¡ºåºç®—å‡ºä¸‹ä¸€ä¸ªæ—¶é—´ï¼Œç´¢å¼•ã€æ—¶é—´æ­¥é•¿ã€èµ·å§‹å°æ—¶ï¼Œèµ·å§‹åˆ†é’Ÿ
</span><span class="k">def</span> <span class="nf">get_scm_time</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">start_hour</span><span class="p">,</span> <span class="n">start_minute</span><span class="p">):</span>
    <span class="n">next_hour</span> <span class="o">=</span> <span class="p">((</span><span class="n">start_hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">start_minute</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span><span class="o">%</span><span class="mi">1440</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span> <span class="c1"># å°æ—¶
</span>    <span class="n">begin_minute</span> <span class="o">=</span> <span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span><span class="o">%</span><span class="mi">60</span>
    <span class="n">next_minute</span> <span class="o">=</span> <span class="n">begin_minute</span> <span class="o">+</span> <span class="n">step</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">next_minute</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">:</span>
        <span class="n">begin_minute</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">next_minute</span> <span class="o">=</span> <span class="n">step</span>
    <span class="n">next_time</span> <span class="o">=</span> <span class="s">"H("</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">begin_minute</span><span class="p">)</span> <span class="o">+</span> <span class="s">"-"</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">next_minute</span><span class="p">)</span> <span class="o">+</span> <span class="s">") "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_hour</span><span class="p">)</span> <span class="o">+</span> <span class="s">" * * *"</span>
    <span class="k">return</span> <span class="n">next_time</span>

 <span class="c1"># åˆ›å»º config.xml æ–‡ä»¶ï¼Œä¼ å…¥é“¾æ¥åˆ—è¡¨ï¼Œåˆ›å»ºæ–‡ä»¶çš„ä¿å­˜è·¯å¾„, config.xml æ–‡ä»¶è·¯å¾„
</span><span class="k">def</span> <span class="nf">create_xml</span><span class="p">(</span><span class="n">links_list</span><span class="p">,</span> <span class="n">xmls_folder</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
    <span class="n">config_lines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># å‚¨å­˜è¡Œ
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>
        <span class="n">config_lines</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c1"># éå†é“¾æ¥åˆ—è¡¨
</span>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">links_list</span><span class="p">):</span>
        <span class="n">branch_group_name</span> <span class="o">=</span> <span class="n">get_branch</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branch_group_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"é“¾æ¥æ— æ•ˆï¼š"</span> <span class="o">+</span> <span class="n">link</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">branch_group</span> <span class="o">=</span> <span class="n">branch_group_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># åˆ†ç»„å
</span>        <span class="n">branch_name</span> <span class="o">=</span> <span class="n">branch_group_name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># åˆ†æ”¯åç§°
</span>        <span class="c1"># åˆ›å»ºæ–‡ä»¶ä¿å­˜åˆ°ä»¥åˆ†æ”¯åå‘½åçš„æ–‡ä»¶å¤¹ä¸­
</span>        <span class="n">branch_folder</span> <span class="o">=</span> <span class="n">xmls_folder</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">branch_name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">branch_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'mkdir '</span> <span class="o">+</span> <span class="n">branch_folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'rm -rf '</span> <span class="o">+</span> <span class="n">branch_folder</span><span class="p">)</span>
        <span class="n">config_xml_path</span> <span class="o">=</span> <span class="n">branch_folder</span> <span class="o">+</span> <span class="s">"/config.xml"</span>
        <span class="c1"># è·å–ä¸‹ä¸€ä¸ªè¿è¡Œçš„æ—¶é—´, æ—¶é—´ä»0ç‚¹0åˆ†å¼€å§‹ï¼Œæ¯10åˆ†é’Ÿè¿è¡Œä¸€ä¸ªç»„ä»¶
</span>        <span class="n">new_time</span> <span class="o">=</span> <span class="n">get_scm_time</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">config_copy</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cg_line</span> <span class="ow">in</span> <span class="n">config_lines</span><span class="p">:</span>
            <span class="n">temp_line</span> <span class="o">=</span> <span class="n">cg_line</span>
            <span class="k">if</span> <span class="n">g_old_branch</span> <span class="ow">in</span> <span class="n">temp_line</span><span class="p">:</span>
                <span class="n">temp_line</span> <span class="o">=</span> <span class="n">temp_line</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">g_old_branch</span><span class="p">,</span> <span class="n">branch_group</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span><span class="n">branch_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g_old_time</span> <span class="ow">in</span> <span class="n">temp_line</span><span class="p">:</span>
                <span class="n">temp_line</span> <span class="o">=</span> <span class="n">temp_line</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">g_old_time</span><span class="p">,</span> <span class="n">new_time</span><span class="p">)</span>
            <span class="n">config_copy</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_line</span><span class="p">)</span>
        <span class="n">xml_str</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_copy</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_xml_path</span><span class="p">,</span> <span class="s">'w+'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_str</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"å·²åˆ›å»º"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s">"ï¼š"</span> <span class="o">+</span> <span class="n">branch_group</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">branch_name</span> <span class="o">+</span> <span class="n">new_time</span><span class="p">)</span>

<span class="c1"># main
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">xmls_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s">"/xmls"</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xmls_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'rm -rf '</span> <span class="o">+</span> <span class="n">xmls_folder</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">'mkdir '</span> <span class="o">+</span> <span class="n">xmls_folder</span><span class="p">)</span>
    <span class="n">links_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span> <span class="s">"/git_links.txt"</span>
    <span class="n">links_list</span> <span class="o">=</span> <span class="n">read_txt</span><span class="p">(</span><span class="n">links_path</span><span class="p">)</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span><span class="o">+</span> <span class="s">"/config.xml"</span>
    <span class="n">create_xml</span><span class="p">(</span><span class="n">links_list</span><span class="p">,</span> <span class="n">xmls_folder</span><span class="p">,</span> <span class="n">config_path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="æŸ¥æ‰¾-xcodeproj-å’Œ-scheme-è„šæœ¬">æŸ¥æ‰¾ xcodeproj å’Œ Scheme è„šæœ¬</h2>

<p>å®šæ—¶æ£€æµ‹ Git æ›´æ–°ï¼Œä½¿ç”¨è„šæœ¬è‡ªåŠ¨ä» Git æ‹‰å–ç»„ä»¶æºç ï¼›è‡ªåŠ¨æŸ¥æ‰¾å®šä½é¡¹ç›® project æ–‡ä»¶åŠé¡¹ç›® schemeï¼Œè‡ªåŠ¨è¿›è¡Œé€ä¸ªæ‰«æã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
# coding=UTF-8
</span>
<span class="s">'''
g_repos_folder ä¸‹æ‹‰ä»£ç ï¼Œå­˜æ”¾ç»„ä»¶ä»£ç çš„è·¯å¾„
'''</span>

<span class="n">g_repos_folder</span> <span class="o">=</span> <span class="s">"/Desktop/GitJH"</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">platform</span>

<span class="c1"># æ‰¾åˆ° xcodeproj å·¥ç¨‹æ–‡ä»¶
</span><span class="k">def</span> <span class="nf">find_project</span><span class="p">(</span><span class="n">branch_dir</span><span class="p">):</span>
    <span class="n">proj_path</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">home</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">branch_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">temp_dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">name_array</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_array</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">file_suffix</span> <span class="o">=</span> <span class="n">name_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># è·å–åç¼€
</span>            <span class="k">if</span> <span class="n">file_suffix</span><span class="p">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">".xcodeproj"</span><span class="p">:</span>
                <span class="n">proj_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">proj_path</span>

<span class="c1"># è·å–æ‰€æœ‰scheme
</span><span class="k">def</span> <span class="nf">get_schemes</span><span class="p">(</span><span class="n">proj_path</span><span class="p">):</span>
    <span class="n">proj_folder</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">proj_path</span><span class="p">)</span>
    <span class="n">xcodebuild_list</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'cd '</span> <span class="o">+</span> <span class="n">proj_folder</span> <span class="o">+</span> <span class="s">' &amp;&amp; xcodebuild -list'</span><span class="p">)</span>
    <span class="n">scheme_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sch_flag</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># æ ‡è®°æ‰¾åˆ°Scheme
</span>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xcodebuild_list</span><span class="p">:</span>
        <span class="n">temp_line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">"Schemes:"</span> <span class="ow">in</span> <span class="n">temp_line</span><span class="p">:</span>
            <span class="n">sch_flag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sch_flag</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">temp_line</span> <span class="o">!=</span> <span class="s">""</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">temp_line</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">endswith</span><span class="p">(</span><span class="s">"bundle"</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">" "</span> <span class="ow">in</span> <span class="n">temp_line</span><span class="p">:</span>
            <span class="n">scheme_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_line</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
            <span class="n">sch_flag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">scheme_list</span>

<span class="c1"># è‡ªåŠ¨æ‹‰å–åˆ†æ”¯
</span><span class="k">def</span> <span class="nf">git_clone</span><span class="p">(</span><span class="n">argv_list</span><span class="p">,</span> <span class="n">branch_dir</span><span class="p">):</span>
    <span class="n">branch_group</span> <span class="o">=</span> <span class="n">argv_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># å‚æ•°1 åˆ†ç»„åç§°
</span>    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">argv_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># å‚æ•°2 åˆ†æ”¯åç§°
</span>    <span class="n">branch_path</span> <span class="o">=</span> <span class="n">branch_dir</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">branch_name</span>
    <span class="c1"># http://192.168.1.44/publicrepos/demo1.git
</span>    <span class="n">branch_link</span> <span class="o">=</span> <span class="s">"http://192.168.1.44/"</span> <span class="o">+</span> <span class="n">branch_group</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">branch_name</span>  <span class="o">+</span> <span class="s">".git"</span>
    <span class="n">git_pwd</span> <span class="o">=</span> <span class="s">"cd "</span> <span class="o">+</span> <span class="n">branch_dir</span> <span class="o">+</span><span class="s">" &amp;&amp; git clone "</span> <span class="o">+</span> <span class="n">branch_link</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">branch_path</span><span class="p">):</span>
        <span class="n">git_pwd</span> <span class="o">=</span> <span class="s">"cd "</span> <span class="o">+</span> <span class="n">branch_path</span> <span class="o">+</span><span class="s">" &amp;&amp; git pull origin master"</span>
    <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="n">git_pwd</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"æ‹‰å–ï¼š"</span> <span class="o">+</span> <span class="n">branch_name</span><span class="p">)</span>

<span class="c1"># è‡ªåŠ¨åŒ– sonar æ‰«æ
</span><span class="k">def</span> <span class="nf">auto_sonar</span><span class="p">(</span><span class="n">argvs</span><span class="p">):</span>
    <span class="n">argv_list</span> <span class="o">=</span> <span class="n">argvs</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Python å‚æ•°é”™è¯¯"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">branch_name</span> <span class="o">=</span> <span class="n">argv_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># åˆ†æ”¯ç»å¯¹è·¯å¾„
</span>    <span class="n">branch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">'~'</span><span class="p">)</span> <span class="o">+</span> <span class="n">g_repos_folder</span>
    <span class="n">branch_path</span> <span class="o">=</span> <span class="n">branch_dir</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">branch_name</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"åˆ†æ”¯è·¯å¾„ï¼š"</span> <span class="o">+</span> <span class="n">branch_path</span><span class="p">)</span>
    <span class="c1"># æ‹‰å–æˆ–è€…cloneåˆ†æ”¯
</span>    <span class="n">git_clone</span><span class="p">(</span><span class="n">argv_list</span><span class="p">,</span> <span class="n">branch_dir</span><span class="p">)</span>
    <span class="c1"># æ‰¾åˆ°å·¥ç¨‹æ–‡ä»¶
</span>    <span class="n">proj_path</span> <span class="o">=</span> <span class="n">find_project</span><span class="p">(</span><span class="n">branch_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"å·¥ç¨‹è·¯å¾„ï¼š"</span> <span class="o">+</span> <span class="n">proj_path</span><span class="p">)</span>
    <span class="c1"># æ‰¾åˆ°æ‰€æœ‰scheme
</span>    <span class="n">scheme_list</span> <span class="o">=</span> <span class="n">get_schemes</span><span class="p">(</span><span class="n">proj_path</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"scheme åˆ—è¡¨ï¼š"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">scheme_list</span><span class="p">))</span>
    <span class="c1"># shell å‚æ•°ï¼Œå‚æ•°1ï¼šåˆ†æ”¯åç§°ï¼›å‚æ•°2ï¼šxcodeproj æ–‡ä»¶å…¨è·¯å¾„ï¼›å‚æ•°3ï¼šscheme
</span>    <span class="k">for</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="n">scheme_list</span><span class="p">:</span>
        <span class="n">sh_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s">'/run-sonar.sh'</span>
        <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="s">"chmod 777 "</span> <span class="o">+</span> <span class="n">sh_path</span><span class="p">)</span>
        <span class="n">sonar_pwd</span> <span class="o">=</span> <span class="s">'sh '</span><span class="o">+</span> <span class="n">sh_path</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">branch_name</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">proj_path</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">scheme</span>
        <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">(</span><span class="n">sonar_pwd</span><span class="p">)</span>

<span class="c1"># ä¸»ç¨‹åº
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"python å‚æ•°å¿…é¡»å¸¦ä¸Š åˆ†ç»„/åˆ†æ”¯åç§°"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">auto_sonar</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div></div>

<h2 id="oclint-æ‰«æä¸Šä¼ -sonarqube-è„šæœ¬">OCLint æ‰«æä¸Šä¼  SonarQube è„šæœ¬</h2>

<p>è‡ªåŠ¨åˆ›å»º Sonar é…ç½®æ–‡ä»¶ï¼Œæ‰«æç»“æœè‡ªåŠ¨å‚¨å­˜åˆ°æ•°æ®åº“ï¼Œé€šè¿‡ç½‘é¡µæŸ¥çœ‹ç»“æœã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># æ£€æµ‹å‚æ•°</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"å‚æ•°1ï¼šåˆ†æ”¯åç§°ä¸èƒ½ä¸ºç©º"</span>
    <span class="nb">exit </span>0
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"å‚æ•°1ï¼š"</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"å‚æ•°2ï¼šxcodeproj æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º"</span>
    <span class="nb">exit </span>0
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"å‚æ•°2ï¼š"</span><span class="nv">$2</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"å‚æ•°3ï¼šscheme åç§°ä¸èƒ½ä¸ºç©º"</span>
    <span class="nb">exit </span>0
<span class="k">fi
</span><span class="nb">echo</span> <span class="s2">"å‚æ•°3ï¼š"</span><span class="nv">$3</span>

<span class="c"># æ£€æµ‹ç¯å¢ƒ</span>
<span class="k">if </span>which xcodebuild 2&gt;/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'xcodebuild exist'</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s1">'xcodebuild æœªå®‰è£…'</span>
<span class="k">fi

if </span>which oclint 2&gt;/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'oclint exist'</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s1">'oclint æœªå®‰è£…'</span>
    <span class="nb">exit </span>0
<span class="k">fi

if </span>which xcpretty 2&gt;/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'xcpretty exist'</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s1">'xcpretty æœªå®‰è£…ï¼Œæ‰§è¡Œ gem install xcpretty å®‰è£…'</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># è·å–è·¯å¾„å’Œscheme</span>
<span class="nv">proj_dir</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="si">)</span>
<span class="nb">cd</span> <span class="s2">"</span><span class="nv">$proj_dir</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">exit </span>0
<span class="nb">echo</span> <span class="s2">"å·¥ç¨‹è·¯å¾„ï¼š"</span><span class="nv">$proj_dir</span>

<span class="c"># æ¸…é™¤ä¸Šæ¬¡çš„ç¼“å­˜</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> ./derivedData <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"æ¸…ç†ç¼“å­˜..."</span>
    <span class="nb">rm</span> <span class="nt">-rf</span> ./derivedData
<span class="k">fi

</span><span class="nv">myworkspace</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="si">)</span>
<span class="nv">myscheme</span><span class="o">=</span><span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>

<span class="c"># xcodebuild clean</span>
xcodebuild clean <span class="nt">-project</span> <span class="s2">"</span><span class="nv">$myworkspace</span><span class="s2">"</span> <span class="nt">-scheme</span> <span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span> <span class="nt">-sdk</span> iphoneos <span class="nt">-configuration</span> Debug

<span class="c"># ç”Ÿæˆç¼–è¯‘æ•°æ®</span>
xcodebuild <span class="nt">-project</span> <span class="s2">"</span><span class="nv">$myworkspace</span><span class="s2">"</span> <span class="nt">-scheme</span> <span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span> <span class="nt">-sdk</span> iphoneos <span class="nt">-configuration</span> Debug <span class="se">\</span>
<span class="nb">arch</span><span class="o">=</span>arm64 <span class="nv">COMPILER_INDEX_STORE_ENABLE</span><span class="o">=</span>NO | xcpretty <span class="nt">-r</span> json-compilation-database <span class="nt">-o</span> compile_commands.json

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> ./compile_commands.json <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ç¼–è¯‘æ•°æ®ç”Ÿæˆå®Œæ¯•"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"ç¼–è¯‘æ•°æ®ç”Ÿæˆå¤±è´¥"</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># ç”ŸæˆæŠ¥å‘Šç›®å½•</span>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> ./sonar-reports <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">mkdir </span>sonar-reports
<span class="k">fi</span>

<span class="c"># åˆ é™¤æ—§æŠ¥å‘Š</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> sonar-reports/<span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span>_oclint.xml <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">rm</span> <span class="nt">-f</span> sonar-reports/<span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span>_oclint.xml
<span class="k">fi</span>

<span class="c"># åˆ†æç¼–è¯‘æ•°æ®</span>
<span class="nv">maxPriority</span><span class="o">=</span>15000
<span class="c"># Disable rules</span>
<span class="nv">LINT_DISABLE_RULES</span><span class="o">=</span><span class="s2">"-disable-rule=LongClass </span><span class="se">\</span><span class="s2">
-disable-rule=LongLine </span><span class="se">\</span><span class="s2">
-disable-rule=LongMethod </span><span class="se">\</span><span class="s2">
-disable-rule=LongVariableName </span><span class="se">\</span><span class="s2">
-disable-rule=ShortVariableName </span><span class="se">\</span><span class="s2">
-disable-rule=HighNcssMethod </span><span class="se">\</span><span class="s2">
-disable-rule=DeepNestedBlock </span><span class="se">\</span><span class="s2">
-disable-rule=TooManyFields </span><span class="se">\</span><span class="s2">
-disable-rule=TooManyMethods </span><span class="se">\</span><span class="s2">
-disable-rule=TooManyParameters </span><span class="se">\</span><span class="s2">
-disable-rule=IvarAssignmentOutsideAccessorsOrInit"</span>

oclint-json-compilation-database <span class="nt">--</span> <span class="se">\</span>
<span class="nt">-report-type</span> pmd <span class="nt">-o</span> sonar-reports/<span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span>_oclint.xml <span class="se">\</span>
<span class="nt">-max-priority-1</span><span class="o">=</span><span class="nv">$maxPriority</span> <span class="se">\</span>
<span class="nt">-max-priority-2</span><span class="o">=</span><span class="nv">$maxPriority</span> <span class="se">\</span>
<span class="nt">-max-priority-3</span><span class="o">=</span><span class="nv">$maxPriority</span> <span class="s2">"</span><span class="nv">$LINT_DISABLE_RULES</span><span class="s2">"</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> sonar-reports/<span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span>_oclint.xml <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"åˆ†æå®Œæˆ"</span>
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"åˆ†æå¤±è´¥"</span>
    <span class="nb">exit </span>0
<span class="k">fi

</span><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/\&amp;/\&amp;amp;/g'</span> sonar-reports/<span class="s2">"</span><span class="nv">$myscheme</span><span class="s2">"</span>_oclint.xml

<span class="c"># ç”Ÿäº§é…ç½®æ–‡ä»¶</span>
<span class="nb">rm</span> <span class="nt">-f</span> sonar-project.properties
<span class="nb">cat</span> <span class="o">&gt;</span> sonar-project.properties <span class="o">&lt;&lt;-</span> <span class="no">EOF</span><span class="sh">
sonar.projectKey=</span><span class="nv">$1</span><span class="sh">
sonar.projectName=</span><span class="nv">$1</span><span class="sh">
sonar.projectVersion=1.0
sonar.language=swift
sonar.sources=.
sonar.swift.simulator=platform=iphoneos,OS=latest
sonar.swift.project=</span><span class="nv">$myworkspace</span><span class="sh">
sonar.swift.appScheme=</span><span class="nv">$myscheme</span><span class="sh">
sonar.swift.appConfiguration=Debug
sonar.sourceEncoding=UTF-8
sonar.swift.excludedPathsFromCoverage=.*Tests.*
sonar.swift.tailor.config=--no-color --max-line-length=100 --max-file-length=500 --max-name-length=40 --max-name-length=40 --min-name-length=4
</span><span class="no">EOF

</span><span class="c"># å‚¨å­˜åˆ° sonar æ•°æ®åº“</span>
/bin/sh sonar-scanner <span class="nt">-X</span>
</code></pre></div></div>

<h2 id="è„šæœ¬æºç ">è„šæœ¬æºç </h2>

<p>è„šæœ¬æºç å·²æ”¾åœ¨ Github ä»“åº“ <a href="https://github.com/muzipiao/dev-shell">https://github.com/muzipiao/dev-shell</a> çš„ sonar-scan æ–‡ä»¶å¤¹ä¸‹ï¼Œç»„ä»¶ Git è·¯å¾„å’Œæ‹‰å–åˆ°æœ¬åœ°çš„è·¯å¾„æœ‰æ‰€ä¸åŒï¼Œéœ€è¦ç®€å•ä¿®æ”¹ï¼Œè¿™äº›è„šæœ¬ä¾›å­¦ä¹ å‚è€ƒã€‚</p>

<p>å¦‚æœæ‚¨è§‰å¾—æœ‰æ‰€å¸®åŠ©ï¼Œè¯·åœ¨<a href="https://github.com/muzipiao/dev-shell">GitHub Shell</a>ä¸Šèµä¸ªStar â­ï¸ï¼Œæ‚¨çš„é¼“åŠ±æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<ul>
  <li>https://blog.csdn.net/weixin_43901866/article/details/86578648</li>
  <li>https://www.jianshu.com/p/3b70aa6af07b</li>
</ul>
:ET